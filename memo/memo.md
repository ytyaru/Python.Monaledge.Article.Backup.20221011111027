モナレッジで書いた自分の記事をバックアップする【python】

　SQLite3に保存する。問題あり。実行するたび自分の全記事のアクセス数が増加し、DBは全記事が更新されてしまう。

<!-- more -->

# ブツ

* [リポジトリ][]

[リポジトリ]:https://github.com/ytyaru/Python.Monaledge.Article.Backup.20221011111027

# 実行

```sh
ADDRESS='モナレッジに登録した自分のモナコイン用アドレス'
NAME='Python.Monaledge.Article.Backup.20221011111027'
git clone https://github.com/ytyaru/$NAME
cd $NAME/src
./run.py $ADDRESS
```

# 結果

　`monaledge.db`というSQLite3ファイルに保存される。

　使い方は前回参照。

* [][]

[]:

## 前回との差異

　微妙にテーブルを変えたので`file.sh`もその修正を反映した。

　`articles`表の`category`列名を`category_id`に変更した。また、外部キーも設定した。

# コード

　長いので割愛。[リポジトリ][]参照。次のようなファイル構成になっている。

ファイル|用途
--------|----
`run.py`|メイン。これを実行する。
`backup.py`|ビジネスロジック。バックアップ処理。
`monaledge-db.py`|モナレッジ記事保存用DB処理。
`db.py`|DB操作用クラス
`monaledge-api.py`|モナレッジAPI。
`api-requester.py`|API実行用クラス

# 課題

## 毎回更新されてしまう

　このツールを実行するたびに毎回DBが更新されてしまう。

　[myArticles][] APIで最新データを取得し、更新日時`updatedAt`がDBのそれより新しければDB更新するようにしている。それでも毎回更新されてしまう。

[myArticles]:
[article]:

　原因はおそらくモナレッジAPIの更新日時が更新されるタイミング。このツールでアクセスするたびアクセス数`access`がインクリメントされ、更新日時もアクセス時刻に変わるのではないかと思われる。おそらく本文を取得する[article][] APIを発行するたびに更新されるのだと思う。そのせいで以下のような問題が生じる。

* このツールでアクセス数がインクリメントされてしまう
* アクセスするたび毎回更新日時がアップデートされてしまう
* 更新日時では記事が変更されたか判断できない
    * 更新判定するためには毎回全記事に[article][] APIを発行してDBと比較することになる

　これは困った。期待する動作としてはタイトル、本文、コメントに変化があるときだけ更新したかった。それ自体はSQLの条件式で可能だと思うが、問題はサーバ負荷。[myArticles][] APIで更新があった記事かどうかを判断してから[article][] APIで本文を取得したかった。たぶん本文のマークダウンは長いテキストで負荷も大きいから別APIなのだと思う。なのでサーバ負荷をさげるためにできるだけ[article][] APIの発行を減らしたい。そのためには[myArticles][]の段階で更新があったかどうか判定したかった。更新があったときだけ本文を取得するようにすれば、[article][] APIの発行回数を必要最小限にできると思っていたから。

　でも、更新日時による更新判定はできないようだ。APIの結果を見る限り、アクセスがあった時点で更新ありと判定されてしまうらしくアクセス数と一緒に更新日時もアップデートされるらしい。本文に変更があったかどうかは、本文同士で比較せねばならないと思われる。つまり、毎回全記事の本文を[article][] APIで取得してDBと比較し更新判定するしかない。これではサーバ負荷を下げることができない。しかも[article][] APIを発行するたびアクセス数や更新日時が変わってしまうように見える。

### どうする？

* 更新された記事のアップデートは諦める
    * DBに既存なら無視する
* 毎回全記事を更新する
    * [article][] APIを発行し、タイトル、本文、コメントに変化があればDBを更新する

　更新を諦めるなら簡単。問題は記事を変更してもそのバックアップがとれないこと。そんなのバックアップと言わない……。

　毎回全記事を更新すると、記事数が増えるほどムダが増えてしまう。たとえば最近一件だけ記事を追加したのでそれをバックアップするために実行したら、全記事のアクセス数がインクリメントされてしまう。これは絶対おかしい。目的外の影響を与えてしまっている。

　妥協案としては、運用の工夫でカバーすることが考えられる。

* 記事の本文を更新したらタイトルも変える（末尾に「追記」や「改稿」などをつける等）

　バックアップツールでは、もしタイトルが変わっていたら本文も変わっていると判断し、[article][] APIで本文を取得してDBを更新する。タイトルが同じレコードは本文を更新対象外とし[article][] APIを発行しない。タイトル変化がどうあれ、アクセス数やモナなど他の項目は[myArticles][]で取得できるので、値に変化があればそれぞれ更新する。

　問題は、タイトルを変更し忘れたら変更後の本文をバックアップできないこと。ヒューマンエラーは確実に起こるので、いつか必ず絶対にヌケモレが発生する。

　とはいえ、現状とれる手段のなかで最も現実的でマシな方法に思える。

方法|問題
----|----
更新された記事のアップデートは諦める|更新後の記事がバックアップできない
毎回全記事を更新する|バックアップするたび**全記事の**アクセス数や更新日時が更新される
記事の本文を更新したらタイトルも変える|タイトルを更新し忘れたら更新後の本文がバックアップされない

　どれも一長一短。今回は毎回全記事更新だったので、次はタイトル更新のみ本文更新するようにしよう。

